<!DOCTYPE html>

<script src="leaflet.js"> // insertion bibliothèque Leaflet : http://leafletjs.com/ </script>

<title>TD3-s7.html</title>
<link rel="stylesheet" type="text/css" href="leaflet.css" /> 
<link rel="stylesheet" type="text/css" href="style.css"/>

<meta charset="utf-8">

<style>
#map { 
    height: 85vh; /* 90% de la hauteur de la fenêtre */
    width: 95%;   /* 95% de la largeur du conteneur */
    margin: 0 auto; /* centrage horizontal */
    position: relative;
    z-index: 1;
}
</style>

<body onload="load_data()">
    <h1>Stations Vélo'v</h1>
    
    <!-- La carte prend maintenant plus d'espace -->
    <div id="map"></div>
    
    <!-- Les autres éléments sont placés après la carte -->
    <div id="reponse">
        <p align="center"></p>
        <img width="70%" src="" />
    </div>
</body>

<script>


// Récupérer le centre géographique des stations et centrer la carte
function initialize_map() {
    var xhr = new XMLHttpRequest();
    xhr.onload = function() {
      if (this.status != 200) {
        console.error("Erreur lors de la récupération du centre des stations");
        return;
      }
      var center = JSON.parse(this.responseText);
      // Centrer la carte sur le centre calculé
      map.setView([center.lat, center.lon], 15);
    };
    xhr.open('GET', '/center', true);
    xhr.send();
}

// Appeler `initialize_map` au lieu de définir directement `setView`
var map = L.map('map');
initialize_map();
// Ajout d'une couche de dalles OpenStreetMap
L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
     attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
     }).addTo(map);
	 
function load_data () {
    var xhr = new XMLHttpRequest();
    xhr.onload = function() {   // fonction callback
	  if (this.status != 200) {  // test erreur 
	    image.src = "";
	    image.alt = "";
	    legende.innerHTML = "Erreur. code = " + this.status;
	    return;
	    }
      
      // Définir une icône personnalisée avec taille spécifique
      var customIcon = L.icon({
          iconUrl: 'images/marker-icon_v.png', // Utiliser votre icône existante
          iconSize: [45, 45],     // Taille de l'icône [largeur, hauteur]
          iconAnchor: [0, 0],   // Point d'ancrage (bas de l'icône)
          popupAnchor: [22, 0]   // Position de la popup
      });
      
      var data = JSON.parse(this.responseText);
      for (n = 0; n < data.length; n++) {
        // Ajouter l'icône personnalisée comme option
        L.marker([data[n].lat, data[n].lon], {icon: customIcon}).addTo(map)
          .bindPopup(data[n].nom)
          .addEventListener('click', OnMarkerClick)
          .idreg = data[n].nom;
      }
    };
    xhr.open('GET', '/regions', true);
    xhr.send();
}

function OnMarkerClick (e) {
    var xhr = new XMLHttpRequest();
	var image =  document.querySelector('#reponse img'),
        legende = document.querySelector('#reponse p');
	xhr.onload = function() {   // fonction callback
	  if (this.status != 200) {  // test erreur 
	    image.src = "";
        image.alt = "";
        legende.innerHTML = "Erreur. code = " + this.status;
		return;
		}
      var data = JSON.parse(this.responseText)
      image.src = data.img;
      image.alt = data.title;
      legende.innerHTML = data.title;
      };
    xhr.open('GET','/ponctualite/'+e.target.idreg,true);  // on récupère la courbe par un appel au serveur
    xhr.send();
}
</script>


